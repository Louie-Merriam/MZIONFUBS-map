<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>MZ &amp; FUBS — Atlas</title>
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet"/>
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet"/>
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" rel="stylesheet"/>
<style>
  :root { --bg:#0b0f14; --panel:#11161d; --ink:#e8f0f7; --muted:#8aa0b5; --border:#213041;
          --birth:#2563eb; --res:#059669; --worship:#7c3aed; --death:#dc2626; --enslave:#f97316; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  body{display:flex;justify-content:flex-start;align-items:stretch}
  .app{height:100%;width:100%;display:grid;grid-template-columns:minmax(280px,360px) 1fr;grid-template-rows:56px 1fr;gap:8px;padding:8px;box-sizing:border-box;justify-items:start;align-items:start}
  header{grid-column:1/-1;display:flex;align-items:center;gap:12px;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:8px 12px}
  header .right{margin-left:auto;display:flex;gap:10px;align-items:center;color:#22c55e;font-size:12px;font-weight:700}
  .sidebar{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;overflow:auto}
  .search{display:grid;gap:8px}
  .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0f141b;color:var(--ink)}
  #results{margin-top:6px;max-height:min(320px,40vh);overflow:auto;border:1px solid var(--border);border-radius:10px;display:none}
  #results button{display:block;width:100%;text-align:left;background:#0f141b;color:var(--ink);border:none;padding:8px 10px;cursor:pointer}
  #results button:hover{background:#14202c}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{border-radius:999px;padding:4px 8px;border:1px solid var(--border);font-size:12px;color:var(--muted)}
  .btn{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#0f141b;color:var(--ink);cursor:pointer}
  .card{background:#0f141b;border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:10px}
  .muted{color:var(--muted);font-size:12px}
  #map{width:100%;height:100%;border-radius:14px;border:1px solid var(--border);background:#0b0f14}

.sidebar .search input{width:100%;box-sizing:border-box;height:40px}

/* Cluster icons */
.mz-cluster { border-radius:50%; }
.mz-cluster .mz-cluster-circle {
  display:flex; align-items:center; justify-content:center;
  width:28px; height:28px; border-radius:50%;
  border:2px solid rgba(11,15,20,0.7);
  box-shadow:0 3px 8px rgba(0,0,0,0.25);
}
.mz-cluster.md .mz-cluster-circle { width:34px; height:34px; }
.mz-cluster.lg .mz-cluster-circle { width:40px; height:40px; }
.mz-cluster span{ color:#061016; font-weight:700; line-height:1; }
</style>
</head>
<body>
<div class="app">
<header>
<b>Interactive Atlas — MZ &amp; FUBS</b>
<div class="right">
<span id="badge">Loading…</span>
<button class="btn" id="zoomAll">Zoom to All</button>
<a class="btn" href="./index.html">← Cover</a>
</div>
</header>
<aside class="sidebar">
<div class="search">
<label class="muted" for="q">Search by name</label>
<input autocomplete="off" id="q" placeholder="Type at least 2 letters (name or surname)" type="text"/>
<div id="results"></div>
<div class="row">
<button class="btn" id="clearBtn">Clear search</button>
</div>
<div class="row" style="margin-top:8px">
<span class="pill"><span style="background:var(--birth);width:10px;height:10px;display:inline-block;border-radius:50%;margin-right:6px"></span>Birthplace</span>
<span class="pill"><span style="background:var(--res);width:10px;height:10px;display:inline-block;border-radius:50%;margin-right:6px"></span>Residence</span>
<span class="pill"><span style="background:var(--worship);width:10px;height:10px;display:inline-block;border-radius:50%;margin-right:6px"></span>Worship</span>
<span class="pill"><span style="background:var(--death);width:10px;height:10px;display:inline-block;border-radius:50%;margin-right:6px"></span>Deathplace</span>
<span class="pill"><span style="background:var(--enslave);width:10px;height:10px;display:inline-block;border-radius:50%;margin-right:6px"></span>Enslavement</span>
</div>
</div>
<div class="card">
<b>Layer toggles (All mode only)</b>
<div class="row" style="margin-top:6px">
<label><input checked="" class="layerToggle" data-layer="birth" type="checkbox"/> Birthplaces</label>
</div>
<div class="row">
<label><input checked="" class="layerToggle" data-layer="residence" type="checkbox"/> Residences</label>
</div>
<div class="row">
<label><input checked="" class="layerToggle" data-layer="worship" type="checkbox"/> Places of Worship</label>
</div>
<div class="row">
<label><input checked="" class="layerToggle" data-layer="death" type="checkbox"/> Deathplaces</label>
</div>
<div class="row">
<label><input checked="" class="layerToggle" data-layer="enslavement" type="checkbox"/> Enslavement</label>
</div>
<div class="muted" style="margin-top:8px">When you select a person, the map switches to <b>Person mode</b> and shows only that individual.</div>
</div>
<div class="card"><b id="who">All mode</b><div class="muted">Use toggles to show global layers, or search for a person.</div></div>
<div class="card"><b>Birthplace</b><div class="muted" id="birthAddr">—</div></div>
<div class="card"><b>Residence</b><div class="muted" id="resAddr">—</div></div>
<div class="card"><b>Place of Worship</b><div class="muted" id="worshipAddr">—</div></div>
<div class="card"><b>Enslavement</b><div class="muted" id="enslavementAddr">—</div></div>
<div class="card"><b>Deathplace</b><div class="muted" id="deathAddr">—</div></div>
</aside>
<main id="map"></main>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
  function escapeHtml(s){ s=(s==null?'':String(s)); return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function norm(s){ return (s||'').normalize('NFKD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
  function gmaps(lat, lon, addr){ return 'https://www.google.com/maps?q='+encodeURIComponent(lat+','+lon)+' ('+encodeURIComponent(addr||'')+')'; }

  const badge = document.getElementById('badge');
  const who = document.getElementById('who');
  const fields = { birth:'birthAddr', residence:'resAddr', enslavement:'enslavementAddr', worship:'worshipAddr', death:'deathAddr' };

  const map = L.map('map', { preferCanvas:true, zoomControl:true }).setView([38.9072,-77.0369], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'© OpenStreetMap'}).addTo(map);

  const COLORS = { birth:'--birth', residence:'--res', enslavement:'--enslave', worship:'--worship', death:'--death' };
  function colorVar(name){ try{ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }catch(e){ return ''; } }

  function clusterOpts(cssVar){
    return {
      showCoverageOnHover:false,
      zoomToBoundsOnClick:true,
      spiderfyOnMaxZoom:true,
      maxClusterRadius:50,
      iconCreateFunction:function(cluster){
        const n=cluster.getChildCount(); let size='sm'; if(n>=100)size='lg'; else if(n>=20)size='md';
        const c = colorVar(cssVar)||'#888';
        return L.divIcon({ html:`<div class="mz-cluster-circle" style="background:${c}"><span>${n}</span></div>`, className:`mz-cluster ${size}`, iconSize:L.point(32,32) });
      }
    };
  }

  const clusters = {
    birth:L.markerClusterGroup(clusterOpts('--birth')),
    residence:L.markerClusterGroup(clusterOpts('--res')),
    enslavement:L.markerClusterGroup(clusterOpts('--enslave')),
    worship:L.markerClusterGroup(clusterOpts('--worship')),
    death:L.markerClusterGroup(clusterOpts('--death'))
  };
  Object.values(clusters).forEach(c => c.addTo(map));
  const personLayer = L.layerGroup().addTo(map);
  const pathLayer = L.layerGroup().addTo(map);
  let PEOPLE=[]; let INDEX=[];

  function normalizePeople(raw){
    return (raw||[]).map(p => {
      const out = { name:p.name };
      ['birth','residence','enslavement','worship','death'].forEach(k=>{
        const s=p[k]; if(!s) return;
        const lat=Number(s.lat), lon=Number(s.lon);
        if(!isFinite(lat) || lat<-90 || lat>90 || !isFinite(lon) || lon<-180 || lon>180){ out[k]=null; }
        else { out[k]={address:s.address||null, lat:lat, lon:lon}; }
      });
      return out;
    });
  }

  function dot(lat, lon, color, html){
    return L.circleMarker([lat,lon], {radius:3, fillColor:color, color:'#0b0f14', weight:1, opacity:1, fillOpacity:.95}).bindPopup(html);
  }
  function toMarker(pt, kind){
    return dot(pt.lat, pt.lon, colorVar(COLORS[kind]), '<b>'+kind.charAt(0).toUpperCase()+kind.slice(1)+'</b><br/><i>'+escapeHtml(pt.name)+'</i><br/>'+escapeHtml(pt.address||''));
  }
  function allPoints(kind){
    const out = [];
    PEOPLE.forEach(p=>{ const s=p[kind]; if(s&&s.lat!=null&&s.lon!=null) out.push({ name:p.name, address:s.address, lat:s.lat, lon:s.lon }); });
    return out;
  }
  function buildGlobal(){
    Object.values(clusters).forEach(c => c.clearLayers());
    const sets = { birth:allPoints('birth'), residence:allPoints('residence'), enslavement:allPoints('enslavement'), worship:allPoints('worship'), death:allPoints('death') };
    Object.entries(sets).forEach(([k, arr])=>{ arr.forEach(pt => clusters[k].addLayer(toMarker(pt, k))); });
    const mk=[]; Object.values(clusters).forEach(c=>c.eachLayer(l=>mk.push(l)));
    if(mk.length){ map.fitBounds(L.featureGroup(mk).getBounds().pad(0.2)); }
  }

  function setDetails(person){
    if(!person){ who.textContent='All mode'; Object.values(fields).forEach(id => document.getElementById(id).textContent='—'); return; }
    who.textContent = person.name;
    Object.entries(fields).forEach(([k,id])=>{
      const s=person[k];
      if(!s || s.lat==null || s.lon==null){ document.getElementById(id).textContent='—'; }
      else { document.getElementById(id).innerHTML = escapeHtml(s.address||'') + '<br/><a target="_blank" href="'+gmaps(s.lat,s.lon,s.address)+'">Open in Google Maps</a>'; }
    });
  }
  function enterAllMode(){
    personLayer.clearLayers(); pathLayer.clearLayers(); setDetails(null);
    document.querySelectorAll('.layerToggle').forEach(cb => cb.disabled=false);
    Object.entries(clusters).forEach(([kind,c])=>{
      const t=document.querySelector('.layerToggle[data-layer="'+kind+'"]');
      if(t && !t.checked){ if(map.hasLayer(c)) map.removeLayer(c); } else { if(!map.hasLayer(c)) c.addTo(map); }
    });
  }
  function enterPersonMode(person){
    document.querySelectorAll('.layerToggle').forEach(cb => cb.disabled=true);
    Object.values(clusters).forEach(c => { if(map.hasLayer(c)) map.removeLayer(c); });
    personLayer.clearLayers(); pathLayer.clearLayers(); setDetails(person);
    const order=['birth','residence','enslavement','worship','death']; const coords=[];
    order.forEach(k=>{ const s=person[k]; if(!s||s.lat==null||s.lon==null) return;
      personLayer.addLayer(dot(s.lat, s.lon, colorVar(COLORS[k]), '<b>'+k.charAt(0).toUpperCase()+k.slice(1)+'</b><br/>'+escapeHtml(s.address||''))); coords.push([s.lat,s.lon]); });
    if(coords.length>=2){ L.polyline(coords, {weight:3, opacity:.85, color:'#8aa0b5', dashArray:'4 6'}).addTo(pathLayer); }
    if(coords.length){ map.fitBounds(L.latLngBounds(coords).pad(0.2)); }
  }

  document.addEventListener('change', e=>{
    const t=e.target; if(!t.classList.contains('layerToggle')) return;
    if(t.disabled) return; const kind=t.dataset.layer; const layer=clusters[kind];
    if(!layer) return; if(t.checked){ if(!map.hasLayer(layer)) layer.addTo(map); } else { if(map.hasLayer(layer)) map.removeLayer(layer); }
  });

  const q=document.getElementById('q'); const results=document.getElementById('results');
  function searchNames(qs){
    const v = norm(qs).trim(); if(v.length<2){ results.style.display='none'; results.innerHTML=''; return []; }
    const parts = v.split(/\s+/).filter(Boolean); const hits=[];
    for(const row of INDEX){ if(!row.norm) continue; let ok=true; for(const p of parts){ if(row.norm.indexOf(p)===-1){ ok=false; break; } } if(ok) hits.push(row.name); if(hits.length>=50) break; }
    results.innerHTML = hits.map(n=>'<button data-name="'+n.replace(/"/g,'&quot;')+'">'+n+'</button>').join('');
    results.style.display = hits.length ? 'block' : 'none'; return hits;
  }
  q.addEventListener('input', e => searchNames(e.target.value));
  q.addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const name=q.value.trim().toLowerCase();
      const p = PEOPLE.find(x=>x.name.toLowerCase()===name) || PEOPLE.find(x=>x.name.toLowerCase().includes(name));
      if(p){ enterPersonMode(p); results.style.display='none'; }
    }
  });
  results.addEventListener('click', e=>{
    if(e.target.tagName!=='BUTTON') return;
    const name=e.target.getAttribute('data-name');
    const p = PEOPLE.find(x=>x.name.toLowerCase()===name.toLowerCase()) || PEOPLE.find(x=>x.name.toLowerCase().includes(name.toLowerCase()));
    if(p){ enterPersonMode(p); results.style.display='none'; }
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{ q.value=''; results.style.display='none'; enterAllMode(); });
  document.getElementById('zoomAll').addEventListener('click', ()=>{
    enterAllMode();
    const mk=[]; Object.values(clusters).forEach(c=>c.eachLayer(l=>mk.push(l)));
    if(mk.length){ map.fitBounds(L.featureGroup(mk).getBounds().pad(0.2)); }
  });

  async function loadData(){
    badge.textContent = 'Loading data…';
    try{
      const res = await fetch('./mz_data_v4.json');
      if(!res.ok) throw new Error('HTTP '+res.status);
      const raw = await res.json();
      PEOPLE = normalizePeople(raw.people||[]);
      INDEX = PEOPLE.map(p => ({ name:p.name, norm:norm(p.name) }));
      buildGlobal();
      enterAllMode();
      badge.textContent = 'Data loaded: ' + PEOPLE.length + ' people';
    }catch(err){
      console.error(err);
      badge.textContent = 'Failed to load data';
    }
  }
  loadData();
</script>
</body>
</html>
